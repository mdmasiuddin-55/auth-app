{% extends "base.html" %}

{% block title %}Chat - Vibesphere{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-4 border-end">
            <div class="d-flex flex-column h-100">
                <!-- Header -->
                <div class="p-3 border-bottom">
                    <h4 class="text-primary mb-0">
                        <i class="fas fa-comments me-2"></i>Messages
                    </h4>
                </div>

                <!-- Search -->
                <div class="p-3 border-bottom">
                    <input type="text" class="form-control" placeholder="Search users..." id="searchUsers">
                </div>

                <!-- Users List -->
                <div class="flex-grow-1 overflow-auto">
                    <div class="list-group list-group-flush">
                        {% for session in chat_sessions %}
                        <a href="javascript:void(0)" class="list-group-item list-group-item-action chat-session" 
                           data-chat-id="{{ session.id }}" data-user-id="{% if session.user1_id == session.user_id %}{{ session.user2_id }}{% else %}{{ session.user1_id }}{% endif %}">
                            <div class="d-flex align-items-center">
                                <div class="position-relative me-3">
                                    {% if session.other_profile_picture %}
                                    <img src="{{ url_for('static', filename=session.other_profile_picture) }}" 
                                         class="rounded-circle" 
                                         style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width: 50px; height: 50px;">
                                        <span class="text-white fw-bold">{{ session.other_username[0]|upper }}</span>
                                    </div>
                                    {% endif %}
                                    {% if session.other_online %}
                                    <span class="position-absolute bottom-0 end-0 bg-success rounded-circle" 
                                          style="width: 12px; height: 12px; border: 2px solid white;"></span>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{{ session.other_username }}</h6>
                                    <small class="text-muted text-truncate d-block">
                                        {% if session.last_message %}
                                        {{ session.last_message|truncate(30) }}
                                        {% else %}
                                        Start a conversation...
                                        {% endif %}
                                    </small>
                                </div>
                                {% if session.last_message_time %}
                                <small class="text-muted">{{ session.last_message_time.strftime('%H:%M') }}</small>
                                {% endif %}
                            </div>
                        </a>
                        {% endfor %}

                        <!-- All Users -->
                        <div class="p-3 border-top">
                            <h6 class="text-muted mb-3">Start New Chat</h6>
                            {% for user in users %}
                            <a href="javascript:void(0)" class="list-group-item list-group-item-action start-chat" 
                               data-user-id="{{ user.id }}">
                                <div class="d-flex align-items-center">
                                    <div class="position-relative me-3">
                                        {% if user.profile_picture %}
                                        <img src="{{ url_for('static', filename=user.profile_picture) }}" 
                                             class="rounded-circle" 
                                             style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <span class="text-white small">{{ user.username[0]|upper }}</span>
                                        </div>
                                        {% endif %}
                                        {% if user.is_online %}
                                        <span class="position-absolute bottom-0 end-0 bg-success rounded-circle" 
                                              style="width: 10px; height: 10px; border: 2px solid white;"></span>
                                        {% endif %}
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0">{{ user.username }}</h6>
                                        <small class="text-muted">
                                            {% if user.is_online %}
                                            <span class="text-success">Online</span>
                                            {% else %}
                                            Last seen {{ user.last_seen.strftime('%H:%M') }}
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-8">
            <div class="d-flex flex-column h-100">
                <!-- Chat Header -->
                <div class="p-3 border-bottom text-center" id="chatHeader">
                    <h5 class="text-muted mb-0">Select a chat to start messaging</h5>
                </div>

                <!-- Messages -->
                <div class="flex-grow-1 overflow-auto p-3" id="messagesContainer" style="max-height: 60vh;">
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Your messages will appear here</p>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="p-3 border-top" id="messageInput" style="display: none;">
                    <form id="messageForm">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Type your message..." id="messageText" required>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
<script>
const socket = io();
let currentChatSessionId = null;

// Socket event handlers
socket.on('connect', function() {
    console.log('Connected to chat server');
});

socket.on('new_message', function(data) {
    if (data.chat_session_id === currentChatSessionId) {
        addMessageToChat(data, data.sender_id === {{ session.user_id }} ? 'sent' : 'received');
        scrollToBottom();
    }
});

socket.on('user_online', function(data) {
    updateUserStatus(data.user_id, true);
});

socket.on('user_offline', function(data) {
    updateUserStatus(data.user_id, false);
});

// Chat session click handler
document.querySelectorAll('.chat-session').forEach(item => {
    item.addEventListener('click', function() {
        const chatSessionId = this.getAttribute('data-chat-id');
        const userId = this.getAttribute('data-user-id');
        loadChat(chatSessionId, userId);
    });
});

// Start new chat handler
document.querySelectorAll('.start-chat').forEach(item => {
    item.addEventListener('click', function() {
        const userId = this.getAttribute('data-user-id');
        startNewChat(userId);
    });
});

// Message form handler
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageText = document.getElementById('messageText').value.trim();
    
    if (messageText && currentChatSessionId) {
        socket.emit('send_message', {
            chat_session_id: currentChatSessionId,
            message_text: messageText
        });
        
        document.getElementById('messageText').value = '';
    }
});

// Search users
document.getElementById('searchUsers').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    document.querySelectorAll('.start-chat').forEach(item => {
        const username = item.querySelector('h6').textContent.toLowerCase();
        item.style.display = username.includes(searchTerm) ? 'block' : 'none';
    });
});

function loadChat(chatSessionId, userId) {
    currentChatSessionId = chatSessionId;
    
    // Show loading
    document.getElementById('messagesContainer').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    // Show message input
    document.getElementById('messageInput').style.display = 'block';
    
    // Fetch messages
    fetch(`/get_messages/${chatSessionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            if (data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center text-muted mt-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                `;
            } else {
                data.messages.forEach(message => {
                    addMessageToChat(message, message.sender_id === {{ session.user_id }} ? 'sent' : 'received');
                });
                scrollToBottom();
            }
            
            // Update chat header
            const chatSessionElement = document.querySelector(`[data-chat-id="${chatSessionId}"]`);
            const username = chatSessionElement.querySelector('h6').textContent;
            const profilePicture = chatSessionElement.querySelector('img')?.src || null;
            
            updateChatHeader(username, profilePicture);
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            alert('Error loading messages');
        });
}

function startNewChat(userId) {
    fetch(`/start_chat/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            // Reload page to show new chat session
            location.reload();
        })
        .catch(error => {
            console.error('Error starting chat:', error);
            alert('Error starting chat');
        });
}

function addMessageToChat(message, type) {
    const messagesContainer = document.getElementById('messagesContainer');
    
    const messageElement = document.createElement('div');
    messageElement.className = `d-flex mb-3 ${type === 'sent' ? 'justify-content-end' : 'justify-content-start'}`;
    
    messageElement.innerHTML = `
        <div class="message-bubble ${type === 'sent' ? 'bg-primary text-white' : 'bg-light'} rounded p-3" 
             style="max-width: 70%;">
            ${type === 'received' ? `
                <div class="d-flex align-items-center mb-2">
                    ${message.profile_picture ? 
                        `<img src="/static/${message.profile_picture}" class="rounded-circle me-2" style="width: 25px; height: 25px; object-fit: cover;">` :
                        `<div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px;">
                            <span class="text-white small">${message.username[0].toUpperCase()}</span>
                        </div>`
                    }
                    <strong class="small">${message.username}</strong>
                </div>
            ` : ''}
            <div class="message-text">${message.message_text}</div>
            <div class="message-time small mt-1 ${type === 'sent' ? 'text-white-50' : 'text-muted'}">
                ${message.created_at}
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageElement);
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('messagesContainer');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function updateChatHeader(username, profilePicture) {
    const chatHeader = document.getElementById('chatHeader');
    chatHeader.innerHTML = `
        <div class="d-flex align-items-center justify-content-center">
            ${profilePicture ? 
                `<img src="${profilePicture}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">` :
                `<div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                    <span class="text-white fw-bold">${username[0].toUpperCase()}</span>
                </div>`
            }
            <h5 class="mb-0">${username}</h5>
        </div>
    `;
}

function updateUserStatus(userId, isOnline) {
    const userElements = document.querySelectorAll(`[data-user-id="${userId}"]`);
    userElements.forEach(element => {
        const statusElement = element.querySelector('.position-absolute');
        if (statusElement) {
            statusElement.className = `position-absolute bottom-0 end-0 rounded-circle ${isOnline ? 'bg-success' : 'bg-secondary'}`;
            statusElement.style.cssText = 'width: 10px; height: 10px; border: 2px solid white;';
            
            const statusText = element.querySelector('.text-muted');
            if (statusText) {
                statusText.innerHTML = isOnline ? 
                    '<span class="text-success">Online</span>' : 
                    'Last seen just now';
            }
        }
    });
}
</script>

<style>
.message-bubble {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
#messagesContainer {
    background-color: #f8f9fa;
}
.list-group-item:hover {
    background-color: #f8f9fa;
}
.chat-session.active {
    background-color: #e3f2fd;
}
</style>
{% endblock %}